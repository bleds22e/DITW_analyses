---
title: "Plots for Poster"
author: "EKB"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data in the Wild: Fall 2023

This document is for making plots based on pre- and post-surveys from the Fall 2023 iteration of Data in the Wild.

### Packages and Data

Load `tidyverse`
```{r}
library(tidyverse)
library(ggalluvial)
```

Data were compiled and sent over by Jill Williams

```{r}
data <- read_csv("../data/Fall_2023_PrePostMatched_DIW_Deidentified.csv", skip = 2) %>% 
  rename(Q39_pre = `Q39...3`, Q39_post = `Q39...4`,
         Q15_pre = `Q15...5`, Q15_post = `Q15...6`,
         Q17_1_pre = `Q17_1...7`, Q17_1_post = `Q17_1...8`,
         Q17_2_pre = `Q17_2...9`, Q17_2_post = `Q17_2...10`,
         Q17_3_pre = `Q17_3...11`, Q17_3_post = `Q17_3...12`,
         Q17_4_pre = `Q17_4...13`, Q17_4_post = `Q17_4...14`) %>% 
  select(Q39_pre:Q17_4_post)
glimpse(data)
```
Pull out the questions and save for later.

```{r}
questions <- data %>% slice(1:2)
questions

data <- data %>% 
  slice(-1) %>% 
  mutate(across(everything(), as.numeric))
head(data)
```

Rearrange data so each question has pre and post values in the same column and create a new column with whether the value is pre or post

```{r}
data_pre <- data %>% 
  select(contains("pre")) %>% 
  mutate(survey = "Pre") %>% 
  rename_with(~ str_remove(., "_pre"))

data_post <- data %>% 
  select(contains("post")) %>% 
  mutate(survey = "Post") %>% 
  rename_with(~ str_remove(., "_post"))

data_long <- bind_rows(data_pre, data_post) %>% 
  mutate(survey = factor(survey, levels = c("Pre", "Post")))
head(data_long)
```

### Plots

Make plots for each question.

Bar plots and river plots?

Bar plots should have the average pre vs. post values with sd values

```{r}
summary_stats <- data_long %>% 
  group_by(survey) %>% 
  summarise(across(where(is.numeric), 
                   list(mean = ~ mean(., na.rm = TRUE),
                        sd = ~ sd(., na.rm = TRUE)))) 
summary_stats

summary_by_question <- summary_stats %>% 
  pivot_longer(contains("Q"), names_to = "question", values_to = "value") %>% 
  # create column for statistic type
    separate(question, c("question", "stat"), extra = "merge", fill = "right") %>% 
    separate(stat, c("temp", "stat"), fill = "left") %>% 
    unite("question", question, temp, na.rm = T) %>% 
  pivot_wider(names_from = question)
head(summary_by_question)
```

#### Bar Plot

```{r}
ggplot(summary_stats, aes(x = survey, y = Q15_mean, color = survey)) +
  geom_point(size = 5) +
  geom_errorbar(aes(ymin = Q15_mean - Q15_sd, ymax = Q15_mean + Q15_sd), width = 0.2) +
  geom_text(aes(label = round(Q15_mean, 1)), hjust = -0.75, color = "black", fontface = "bold", size = 8) +
  scale_y_continuous(limits = c(0, 5)) +
  scale_color_viridis_d(direction = -1, begin = 0.1, end = 0.9) +
  labs(x = "Survey",
       fill = "Survey") +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        legend.position = "none",
        axis.title = element_text(face = "bold", size = 20),
        axis.text = element_text(size = 14))
```

#### River Plot

River plots connect frequencies of categorical responses

```{r}
river_data <- data %>% 
  select(Q15_pre, Q15_post) %>% 
  drop_na() %>% 
  group_by(Q15_pre, Q15_post) %>% 
  count() %>% 
  mutate(pre = case_when(Q15_pre == 1 ~ "Very Disinterested",
                         Q15_pre == 2 ~ "Somewhat Disinterested",
                         Q15_pre == 3 ~ "Neutral",
                         Q15_pre == 4 ~ "Somewhat Interested",
                         Q15_pre == 5 ~ "Very Interested"),
         post = case_when(Q15_post == 1 ~ "Very Disinterested",
                         Q15_post == 2 ~ "Somewhat Disinterested",
                         Q15_post == 3 ~ "Neutral",
                         Q15_post == 4 ~ "Somewhat Interested",
                         Q15_post == 5 ~ "Very Interested")) %>% 
  mutate(pre = factor(pre, levels = c("Very Interested", "Somewhat Interested", "Neutral", "Somewhat Disinterested", "Very Disinterested")),
         post = factor(post, levels = c("Very Interested", "Somewhat Interested", "Neutral", "Somewhat Disinterested", "Very Disinterested")))
```

Make river plot

```{r}
ggplot(river_data, aes(axis1 = pre, axis2 = post, y = n)) +
  geom_alluvium(aes(fill = post),
                curve_type = "cubic") +
  geom_stratum(aes(fill = post)) +
  geom_text(stat = "stratum",
            aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("Pre", "Post"),
                   expand = c(0.15, 0.05)) +
  scale_fill_viridis_d() +  
  theme_void()
```

